<view class="container">
  <!-- 顶部控制面板移除，采用缩略图后的上传卡片与底栏方向按钮 -->

  <movable-area class="thumbArea" style="height: {{thumbsHeight}}px;">
    <block wx:for="{{images}}" wx:key="tempFilePath">
      <movable-view class="thumbMV" direction="all" inertia="false" out-of-bounds="true" damping="60" friction="2" x="{{item.x}}" y="{{item.y}}" style="width: {{thumbWpx}}px; height: {{thumbWpx}}px;" data-index="{{index}}" bindtouchstart="onDragStart" bindchange="onDragMoving" bindtouchend="onDragEnd">
        <view class="thumbBox {{selectedIndex===index?'selected':''}}" data-index="{{index}}" catchtap="onTapThumb" bindlongpress="onLongPressThumb">
          <image class="thumbImg" src="{{item.tempFilePath}}" mode="aspectFill"/>
          <view wx:if="{{multiSelectMode}}" class="selBadge {{item.selected?'checked':''}}" data-index="{{index}}" catchtap="onToggleSelect">
            <text wx:if="{{item.selected}}" class="selTick">✓</text>
          </view>
        </view>
      </movable-view>
    </block>
    <!-- 上传图片占位卡片（同层 movable-view，避免被覆盖） -->
    <movable-view class="thumbMV" direction="all" disabled="true" x="{{addX}}" y="{{addY}}" style="width: {{thumbWpx}}px; height: {{thumbWpx}}px;">
      <view class="addTile" catchtap="onTapAdd">
        <view class="addPlus">+</view>
        <text class="addText">上传图片</text>
      </view>
    </movable-view>
  </movable-area>

  <!-- 温馨提示：容器始终存在，双击容器切换透明/恢复 -->
  <view class="tips" bindtap="onTipsTap">
    <view class="tipsInner {{tipsTransparent?'transparent':''}}">
      <text>温馨提示：</text>
      <text> 1. 长按图片拖拽可变换位置</text>
      <text> 2. 长按图片可选择要删除的图片</text>  
      <text> 3. 长按底部拼接按钮可进行拼图设置</text>
      <text> 4. 拼接完成后的预览页面，长按图片可保存拼接图</text>
      <text> 5. 熟悉提示后，双击温馨提示区域，可隐藏/显示温馨提示</text>
      <text> 6. 当图片太大超过应用/微信/小程序的尺寸阈值时，也会适当进行压缩</text>
    </view>
  </view>

  <!-- 隐藏预览画布，仅供内部绘制使用（不再显示预览框） -->
  <view class="canvasWrap hidden">
    <canvas type="2d" id="preview" canvas-id="preview" style="width: 100%; height: 1px; background:#fff;"></canvas>
  </view>

  <!-- 拼图中：全屏遮罩 + 居中进度条，拦截所有操作 -->
  <view wx:if="{{isStitching}}" class="busyMask" catchtouchmove="true" catchtap="noop">
    <view class="busyBox">
      <view class="progressBar">
        <view class="progressInner" style="width: {{stitchProgress}}%;"></view>
      </view>
      <text class="progressText">{{stitchProgress}}%</text>
      <text class="progressNote">拼图进行中，请不要关闭页面</text>
    </view>
  </view>

  <!-- 大图加载：超过阈值时展示进度，避免“无响应”体验 -->
  <view wx:if="{{isPreparing}}" class="busyMask" catchtouchmove="true" catchtap="noop">
    <view class="busyBox">
      <view class="progressBar">
        <view class="progressInner" style="width: {{prepareProgress}}%;"></view>
      </view>
      <text class="progressText">{{prepareProgress}}%</text>
      <text class="progressNote">{{prepareNote}}（约 {{prepareTotalMB}}MB）</text>
    </view>
  </view>

  

  <!-- 固定底栏：竖向/横向拼接（支持长按设置间距） -->
  <view class="fixedBar" wx:if="{{!multiSelectMode}}">
    <button class="barBtn" bindtap="onStitchVertical" bindlongpress="onLongPressVertical" disabled="{{isStitching}}">
      <view class="barIcon v">
        <view class="seg"></view>
        <view class="seg"></view>
        <view class="seg"></view>
      </view>
      <text class="barText">竖向拼接</text>
    </button>
    <button class="barBtn" bindtap="onStitchHorizontal" bindlongpress="onLongPressHorizontal" disabled="{{isStitching}}">
      <view class="barIcon h">
        <view class="seg"></view>
        <view class="seg"></view>
        <view class="seg"></view>
      </view>
      <text class="barText">横向拼接</text>
    </button>
  </view>

  <!-- 多选模式底栏 -->
  <view class="fixedBar" wx:if="{{multiSelectMode}}">
    <button class="barBtn" bindtap="onCancelSelect" disabled="{{isStitching}}">
      <text class="barGlyph">↩︎</text>
      <text class="barText">取消</text>
    </button>
    <button class="barBtn" bindtap="onDeleteSelected" disabled="{{selectedCount===0 || isStitching}}">
      <text class="barGlyph">🗑️</text>
      <text class="barText">删除所选图片</text>
    </button>
  </view>

  
  <!-- 拼接设置（长按拼接按钮） -->
  <view wx:if="{{showGapModal}}" class="modalRoot">
    <view class="modalMask" catchtouchmove="true" bindtap="onCancelGap"></view>
    <view class="modalBody">
      <view class="modalTitle center">{{gapModalTitle}}</view>
      <view class="row">
        <text class="label">拼接方式</text>
        <view class="modeSegment">
          <view class="segItem {{modeTemp==='min'?'active':''}}" bindtap="onSelectMode" data-mode="min">{{modeLabel1}}</view>
          <view class="segItem {{modeTemp==='max'?'active':''}}" bindtap="onSelectMode" data-mode="max">{{modeLabel2}}</view>
          <view class="segItem {{modeTemp==='original'?'active':''}}" bindtap="onSelectMode" data-mode="original">原尺寸</view>
        </view>
      </view>
      <view class="rowNoLabel">
        <view class="modePreview">
          <view class="previewBox">
            <text class="previewTitle">拼接前</text>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='vertical'}}">
              <view class="pLine" style="width: 60%;"></view>
              <view class="pLine" style="width: 100%;"></view>
              <view class="pLine" style="width: 80%;"></view>
            </view>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='horizontal'}}">
              <view class="pLineH" style="height: 60%;"></view>
              <view class="pLineH" style="height: 100%;"></view>
              <view class="pLineH" style="height: 80%;"></view>
            </view>
          </view>
          <text class="previewArrow">→</text>
          <view class="previewBox">
            <text class="previewTitle">拼接后</text>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='vertical' && modeTemp==='min'}}">
              <view class="pLine" style="width: 60%;"></view>
              <view class="pLine" style="width: 60%;"></view>
              <view class="pLine" style="width: 60%;"></view>
            </view>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='vertical' && modeTemp==='max'}}">
              <view class="pLine" style="width: 100%;"></view>
              <view class="pLine" style="width: 100%;"></view>
              <view class="pLine" style="width: 100%;"></view>
            </view>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='vertical' && modeTemp==='original'}}">
              <view class="pLine centered" style="width: 60%;"></view>
              <view class="pLine centered" style="width: 100%;"></view>
              <view class="pLine centered" style="width: 80%;"></view>
            </view>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='horizontal' && modeTemp==='min'}}">
              <view class="pLineH" style="height: 60%;"></view>
              <view class="pLineH" style="height: 60%;"></view>
              <view class="pLineH" style="height: 60%;"></view>
            </view>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='horizontal' && modeTemp==='max'}}">
              <view class="pLineH" style="height: 100%;"></view>
              <view class="pLineH" style="height: 100%;"></view>
              <view class="pLineH" style="height: 100%;"></view>
            </view>
            <view class="previewIcon {{modalDirection}}" wx:if="{{modalDirection==='horizontal' && modeTemp==='original'}}">
              <view class="pLineH centered" style="height: 60%;"></view>
              <view class="pLineH centered" style="height: 100%;"></view>
              <view class="pLineH centered" style="height: 80%;"></view>
            </view>
          </view>
        </view>
      </view>
      <view class="rowNoLabel" wx:if="{{modeDescLines.length}}">
        <view class="modeDesc">
          <block wx:for="{{modeDescLines}}" wx:key="index">
            <text>{{item}}</text>
          </block>
        </view>
      </view>
      <view class="row">
        <text class="label">图间距</text>
        <view class="gapControls">
          <view class="stepBtn" bindtap="onGapDec">-</view>
          <view class="gapNumberWrap" bindtap="onGapNumberTap">
            <text class="gapNumber" wx:if="{{!gapInputFocus}}">{{gapTemp}}</text>
            <input class="gapInput2 {{gapInputFocus?'editing':''}}" type="number" value="{{gapTemp}}" focus="{{gapInputFocus}}" bindblur="onGapInputBlur" bindconfirm="onGapInputConfirm" bindfocus="onGapInputFocus"/>
          </view>
          <view class="stepBtn" bindtap="onGapInc">+</view>
        </view>
      </view>
      <view class="rowNoLabel">
        <text class="hint">图间距值在0～20</text>
      </view>
      <view class="modalBtns">
        <button class="btn" bindtap="onCancelGap">取消</button>
        <button class="btn primary" bindtap="onConfirmGap">确定</button>
      </view>
    </view>
  </view>

  <!-- 删除确认对话框 -->
  <view wx:if="{{showDeleteModal}}" class="modalRoot">
    <view class="modalMask" catchtouchmove="true" bindtap="onCancelDelete"></view>
    <view class="modalBody">
      <image class="modalImg" src="{{modalImage}}" mode="aspectFit"/>
      <view class="modalBtns">
        <button class="btn" bindtap="onCancelDelete">取消删除</button>
        <button class="btn primary" bindtap="onConfirmDelete">确认删除</button>
      </view>
    </view>
  </view>
</view>
